<h2>
Error Control
</h2>

Error control in Enstore is simple, because much of the system state
is stored in the <em>encp</em> client. The <em>encp</em> client can be given a
"retry-able error" and will resend data for a write into the system, or the
system can re-start a read from the system from scratch. This re-try
is given a very high priority when it is received by the library
manager -- put on the head of the unassigned work queue.

The Enstore system keeps unassigned read and write requests in a queue of
unallocated work in the library manager. Once a read or write requests'
turn comes, the library manager puts the request in a "work awaiting
mount" or "work at mover" queue. The reason for this is to track the
volumes for scheduling : the library manager must not command a different mover
to mount a tape for another mover. It is the mover, and not the library
manager which completes requests.

The three library manager queues are: 
<ul>
<li>Unscheduled work
<li>work awaiting a volume mount
<li>work at a mover.
</ul>
<p>
It is important to keep these queues consistent. Tape and reading
errors are handled in the mover, and can be handled by detailed design in 
the mover.
<p>
Many interesting errors are related to when the tape cannot be written
or read, or when it is suspected that tape is jammed, etc.
<p>
We need experience with the actual hardware. In the interim we make the 
following assumptions:
<ul>
<li>
If we have trouble during a load or unload operation, we assume that
the tape is physically jammed. Until a human looks at the problem, we
will permit no future operations on the drive or the volume.
<li>
If we have errors on writing a volume, we will not write on that
volume anymore.
<li>
If a tape drive has errors on "consecutive" tapes, we should "stop
using the tape drive". The number of errors allowed should be picked
up through the mover configuration, since we may have "more
temperamental" and "less temperamental" drives, we may want to
configure this parameter for each mover individually. 
<li>
If tape reads or spaces give error, we should track the errors. If
the recent history of the tape shows many errors, we should mark the
tape "no access" and bring it to the attention of an administrator.
Therefore, the Volume Clerk needs to track the "recent history" of
errors, and have a per-volume figure of merit which will mark the tape
for no access, given many recent errors.
<li>
Library manager:
<br>
Two Features should be added to the tickets to support re-tries. 
<ul>
<li>Tickets should be marked as retries or not by <em>encp</em>. Retries go 
to the head of the queue.
<li>Tickets should be marked with an "avoid this mover" field for read
retries, so the same tape drive can be avoided.
</ul>
<em>encp</em> should generate these fields appropriately, and the queuing logic
in the library manager ought to implement the logic associated with these
fields.
<p>
The Enstore system should check the read/write state of a tape read very
early when the request is queued, to give an error if the access
is not allowed. However, an error may change the state of a tape while
its corresponding work is in the library manager queue. Therefore, a
late check is required. The system already performs a "late check"
for writes, since a volume must be selected for every file. The system
needs a "late check" for reads. Failing a late check means contacting
<em>encp</em> to give it the bad news. The contact should be done in the mover,
not in the library manager, just before the mover goes off to mount the volume
for read, since the mover is better able to tolerate a very slow or
non-existent <em>encp</em>. It is good to contact 
<em>encp</em> before a mount, too, since people _will_ ^C <em>encp</em>'s and
it is best to discover this _before_ incurring the expense of a mount.
<li>
"Freeze the tape in the drive" means:
<ul>
<li>Not unloading the tape from the drive
<li>Freezing the tape
<li>Off-lining the Drive
</ul>
<li>
"Freezing the tape" means:
<ul>
<li>mark the tape as "system noaccess"
<li>log that this happened and let an administrator look at the
problem in the morning.
<li><em>encp</em> shall not re-try.
</ul>
<li>
"Off-lining the drive" means:
<ul>
<li>Preserving as much state as possible.
<li>Writing a complete description in an error log.
<li>Leaving the problem until business hours unless the capacity of
the system falls below a threshold.
</ul>
</ul>

<h3>
Tape Write Errors
</h3>

<h4>WRITE_NOTAPE:</h4>
"no such tape" error in library mount failure on write.
If this happens, the volume data base is inconsistent with reality.
Mover shall freeze the tape.
<em>encp</em> shall retry.

<h4>WRITE_TAPEBUSY:</h4>
"The media changer says that the tape is in another drive"
Enstore has a bug, or some other system has mounted the tape or library
micro put the tape somewhere else.
Mover shall freeze the tape.
<em>encp</em> shall retry.

<h4>WRITE_BADMOUNT:</h4>
Other mount failure on write, or load operation failed.
Must assume jammed tape.
Mover shall freeze the tape in the drive.
<em>encp</em> shall re-try

<h4>WRITE_BADSPACE:</h4>
"EOD cookie does not produce EOD"
Wrong tape, software bug or drive space error.
Mover shall freeze the tape in the drive.
<em>encp</em> shall retry.

<h4>WRITE_ERROR:</h4>
"Error when writing data block or file mark"
Run of the mill write error.
If the drive has had many recent errors, Mover shall "offline the drive"
The volume shall be marked read-only.
<em>encp</em> shall re-try.

<h4>WRITE_EOT:</h4>
"Hit EOT while writing data block or file mark"
Hit EOT. Mover shall mark volume full.
<em>encp</em> shall retry. 

<h4>WRITE_UNLOAD:</h4>
"error when unloading tape from drive"
Must assume that the tape is physically jammed.
Mover shall freeze the tape in the drive.
<em>encp</em> shall retry.
No <em>encp</em> is associated with the tape at this time.

<h4>WRITE_UNMOUNT</h4>
"Media changer gives error when unmounting tape"
Should not happen. Maybe the tape is hanging in the drive. Does no harm.
Mover shall freeze the tape in the drive.
No <em>encp</em> is associated with the tape at this time.

<h4>WRITE_NOBLANKS:</h4>
The volume clerk has no blank volumes to give.
The requests shall return an error. 
(do not "wait forever" -- DAQ should switch to an alternate library)
An administrator shall be paged.

<h3>Tape Read Errors</h3>

<h4>READ_NOTAPE:</h4>
"No such tape in library" mount failure on read.
If this happens, the volume data base is inconsistent with reality.
Mover shall freeze the tape.

<h4>READ_TAPE_BUSY:</h4>
"The media changer says that the tape is in another drive"
Enstore has a bug, or some other system has mounted the tape or the library
micro put the tape somewhere else.
Mover shall freeze the tape.

<h4>READ_BADMOUNT:</h4>
Other Mount failure on read, or load operation failed.
We have to assume that the tape is jammed in the drive.
Mover shall freeze the tape in the drive.

<h4>READ_BADLOCATE:</h4>
Failed space or initial CRC's don't match on initial read.
We have attempted to space to a file on the tape. Either the file location
cookie is somehow corrupted, we have the wrong tape in the drive or
the tape drive cannot space properly. 
Mover shall freeze the tape in the drive.
<em>encp</em> shall not retry

<h4>READ_ERROR:</h4>
Error when reading data block.
Run of the mill read error. Mover shall consider the recent error history of
the drive and the volume.
If the drive has had many recent errors, mover shall offline the drive.
<em>encp</em> shall re-try.
If the volume has had many recent errors,
mover shall freeze the tape.
<em>encp</em> shall not retry.
If the volume has had few recent errors,
mover shall fail the transfer
<em>encp</em> shall re-try, and annotate that this mover shall be avoided.

<h4>READ_COMP_CRC:</h4>
Failure of complete CRC.
This needs investigating, as it should not happen. The drive and the tape
are suspicious. Corrupt file location cookie, drive space error, wrong tape
in the drive, etc.
Mover shall freeze the tape in the drive.
<em>encp</em> shall not retry.

<h4>READ_EOT:</h4>
Hit EOT when reading.
Should not happen. Corrupt file location cookie, drive space error, or
wrong tape in the drive. Should have hit an EOF.
Mover shall freeze the tape in the drive.
<em>encp</em> shall not retry.

<h4>READ_EOD:</h4>
Hit EOD when reading.
Should not happen. Corrupt file location cookie, drive space error, or
wrong tape in the drive. Should have hit an EOF.
Mover shall freeze the tape in the drive.
<em>encp</em> shall not retry.

<h4>READ_UNLOAD:</h4>
Error when unloading tape.
Must assume that the tape is physically jammed.
Mover shall freeze the tape in the drive.
No <em>encp</em> is associated with the tape at this time.

<h4>READ_UNMOUNT:</h4>
Error from media changer when unloading tape.
Should not happen. Maybe the tape is hanging in the drive. Does no harm.
Mover shall freeze the tape in the drive.
No <em>encp</em> is associated with the tape at this time

<h3>Other Errors</h3>

<h4>ENCP_GONE:</h4>
<em>encp</em> has gone away while request is queued.
The mover contacts <em>encp</em> to ping it before a mount, and if 
<em>encp</em> is not there, the mover does not go on to contact the media 
changer, but instead returns a UNILATERAL_UNBIND to the library manager.

<h4>TCP_HUNG:</h4>
DESY reports that 
<ul>
<li>sometimes machines can crash....
<li><em>encp</em> processes can be killed in a way that...
<li><em>encp</em> client's disks many fill up ...
<li>etc...
</ul>
which are all seen as the data TCP link is seen to
just hang. 

DESY's treatment is "harsh" -- They compute an anticipated transfer
time for every socket operation and abort the transfer if the
actual transfer takes more than several times the expected value.
Right now, Enstore does not consider this to be an error and just
waits. However, we are vulnerable to disaster. It is possible to see
circumstances where we might tie all the movers up if, say, one clients
system's disk fills up.

<h4>LM_CRASH:</h4>
If a library manager crashes, and loses its queue of pending
work, the <em>encp</em>'s will never be called back, and will wait
forever. This is a problem. A basis for the solution is for a waiting 
<em>encp</em> to
ping its library manager, every 30 mins to see if its request has gotten lost.
It would also be good if a --timeout switch was available to <em>encp</em>,
since the users may wish to get an error rather than suffer a long
delay.

<h4>MOVER_CRASH:</h4>

<ul>
<li>
Case 1) If a mover is connected to an <em>encp</em>, then <em>encp</em> will
notice its sockets being torn down prematurely. <em>encp</em> shall retry. This
is not good enough.
<p>
For reads, the volume is tied up because the library manager has the volume as
being "at a mover". The retry will be hung in the library manager queue
because the library manager is unaware of the mover crash.
<p>
For writes, 1 is effectively deducted from the file family width,
since the library manager is unaware of the mover crash.
<p>
This is all a bug, the minimal effect of a mover crash should be:
<ul>
<li>
Since the status of the volume is unknown, the status should be akin
to "freeze drive and volume". However, subsequent reads will not produce an
error, but will be queued until the mover is restarted.
<li>
Allow writes to continue on a different volume of the same file 
family, without affecting the "width".
</ul>
<p>
<li>
Case 2) Mover has a volume, but is not associated with an <em>encp</em> and 
crashes.
Same problems as case 1) but <em>encp</em> will notice.
The total amount of time spent in this possibility is small compared to
the time corresponding to case 1 and case 3.
<p>
<li>
Case 3) Mover is idle.
This is O.K. The system degrades as specified.
</ul>