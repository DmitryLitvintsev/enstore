

<h1>Volume Import and Export</h1>

<p>It is trivially possible to import and export by copying disk-resident data
from enstore using the ENCP command. </P>

<p>However, Given a need to move alot of data, and compatible tape drives and
media, it is potentially more efficient to interchange tape volumes: to write
tapes outside of Enstore and import them into the system, and to write tapes
inside of Enstore and remove them from the system. In this way, for example,
Enstore can be used as a kind of tape copy facility. The remainder of this
note deals with this type of volume import/export. </p>

<p> What follows are draft design notions, Import and Export are to be
implemented after the review.

<h2> Volume Export </h2>


<h3> Building an Exportable Volume</h3>

<p> Exportable volumes are built in Enstore using the ENCP command, with the
command line switch specifying an temporary, "ephemeral" file family. An
ephemeral file family is a unique file family name created for this ENCP
command, with a file family width of one. Under these conditions, files will
be placed on tape volumes in the order specified.

<p>The idea is that the  experimenter should follow the following steps:

<ul>

<li> Select a file structuring method which is supported in Enstore, which
your users can read, and complies with tape interchange standards of your
experiment.  (for D0 this is the CPIO format).

<li> Decide what kind of media you want for the exported volume. (for D0
this will be the media selected by the SMWG.)

<li> Identify and make disk-resident all the files that you want to put on a
volume. Consider the capacity of the tape, and whether you can tolerate files
overflowing onto another volume.

<li> Specify those files on a single ENCP command line, in the order you would
like to have them placed on tape. Use the ENCP an "ephemeral" file family
switch on the command line.

<li> Optionally generate meta-data for the volume, if your user will want to
know what files are on a tape.

<li> Move the volume form the robot to a shelf library, using an Enstore
administration tool.

<li> Remove the volume from the Enstore system, using an Enstore
administration tool.

</ul>


<h3> Reading an Exportable Volume </h3>

An experiment can make tapes in the Enstore system at Fermilab, and
give the volumes to an experimenter, who can read the tapes anywhere.
Experimenters can generate a file which is a map of the tape. However,
some tape formats are sufficiently self-describing so that the tape may
be dumped to disk with standard utilities.

As an example, an experimenter can stage an entire CPIO exported volume using
gnu CPIO, say, at her home institution. (Since there are many files on an
Enstore tape, special care should be taken to _not_ select a "rewind" tape
device.

On a UNIX system, CPIO tapes can be read with no special infrastructure than 
gnu CPIO. The  user should just take care to not select a "rewind" tape device.

<pre>
#!/bin/sh

# en_dump_tape  A shell script to dump an  Enstore cpio format tape.
# This is pseudo code, not functional yet

$tape=$1
test ! -f $tape || exit 1  ## Try to make sure we have not selected a device file
while /bin/true ; do  
   mt -t $tape fsf 1      || exit 1
   (dd if=$tape  | cpio -o  )  || exit 1
done

</pre>

<h2> Import </h2>


<h3> Building an Importable Volume</h3>

<p> Volume import is a good implementation for repeated and sizeable
transfers of data, It is not a good choice for small, occasional
transfers.

<h4> Planning </h4>

<p> Tapes in a robot require special labels, so that can be automatically
scanned and placed in the robot. The labels must be unique within a robot and
within an Enstore system. You will need to procure tape volumes with labels
meeting these requirements. Imported tapes are read-only in Enstore. (Details
of these requirements are TBD, after the serial media working group
decision). </p>

<p>Imported tapes are read-only in Enstore<p>

<p>It is very likely that a tool will have to be produced to get good
results</P>

<p>If the tapes are to be accessed many times, the experiment must take some
time to think about the layout of data on the tapes and how the files ought
to fit into the Enstore name space.

<ul>
 <li> Files that are accessed together should likely be put on the same tape. 
 <li> Most likely, the same file should not be placed on more than one tape. 
 <li> Files must definitely _not_ span tapes. 
 <li> If a likely order of future access is known, files should be put on 
	tape in that order.
 <li> Think of how you would like the files to appear in the Enstore name
        space.
 <li> Identify a file structuring method that is compatible with Enstore and
        your experiments data interchange standards.
 <li> Files should be written with a blocksize yielding good performance.
	(precise recommendation is TBD, after SMWG decision).
 <li> Files should be written with the recommended partitioning.
	(precise recommendation is TBD, after SMWG decision).

</ul>

<p> Since the objective is to import a large amount of data, it is required to
generate metadata for each tape -- else the tape will have to be scanned to
determine the meta data.


<p> Meta-data for each tape is:

<ul>
<li> The external, bar-coded label of the tape.
<li> The kind of tape media
<li> The file structuring method used to generate the tape.
<li> The blocksize used in writing the tape.
</ul>

<p> Meta-data for each file is :

<ul>
<li> An Adler 32 CRC of the first 65536 bytes of the file.
<li> An Adler 32 CRC of all the bytes in the file.
<li> The number of file marks preceding the beginning of the wrapper.
<li> The number of the partition holding the file (if this feature is used)
<li> A name for the file.
<li> A path for the file in the PNFS namespace.
</ul>


<p> The procedure the user would follow is:

<ul>
 <li>Identify the files you want to put on a tape.
 <li>Put an optically bar-coded tape in the tape drive
 <li>Using a tool we provide:
 <ul>
   <li>Place the files on the tape.
   <li>Emit meta-data for that file.
 </ul>
 <li> Remove the tape from the drive.
</ul>


<h3> Importing a  Volume </h3>

<p> The procedure for importing a volume is:

<ul>
  <li> Deliver the volume to the data center.

  <li> Use an Enstore administration utility to make a record for the volume
  in the volume table, using the volume meta data, and physical
  location as the shelf library.

  <li> Use an Enstore administration utility to place the meta-data for
  each file into the file table.

</ul>









