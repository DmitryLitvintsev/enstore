#!/bin/sh
set -u
if [ "${1:-}" = "-x" ] ; then set -xv; shift; fi

node=`hostname -s`
gang=`gang`

date

# obtain list of valid libraries
enstore conf --show | sed -n "s/.*'\([a-zA-Z0-9][-a-zA-Z0-9]*\)\.library_manager'.*/\1/ p" | sort -u >/tmp/valid-library

if [ $gang = "stken" ]; then

# stken 9310 silos are acs 0 & lsm 0,1
# stken 8500 rails are acs 0 & lsm 0-3

# for "query drive" (ACSLS 6), each line in the silo inventory is in one of four formats:
#   vol   home		acs, lsm, panel, row, col	type
#   vol   in drive	acs, lsm, panel, drive		type
#   vol   in transit	acs, lsm, panel, row, col	type
#   vol   in transit	acs, lsm, panel, drive		type
# where type is one of STK1R, STK1U, STK2P, STK2W
#
# for "display" (ACSLS 7), each line in the silo inventory has ten fields:
#   Vol_id  Acs  Lsm  Panel  Row  Column  Pool   Status    Media     Type
# where
#   Status is one of dismount, eject, enter, mount, home, in_drive, move, missing, absent, ejected
#   Media is one of STK1R, STK1U, STK2P, STK2W
#   Type is one of data, clean
#
# each line in the tower inventory is in this format:
# volser xxnnnn media DECDLT attrib {Empty|Ejected|Mounted|Occupied}
#
# all lines of enstore inventory have ten fields, in this format:
#   vol   avail   system_inhibit   user_inhibit   library   wp_status	mounts   volume_family
# where each inhibit takes two fields (including parentheses)
#
# there should be no deleted volumes in VOLUMES_DEFINED

egrep -v "^$|^<|DG [0-9][0-9][0-9]" /diska/tape-inventory/STK-VOLUMES.html |\
  awk 'NF==10 || /         0, [01],/ {print $1}' |\
  sort >/tmp/silo-volumes
egrep -v "^$|^<|DG [0-9][0-9][0-9]" /diska/tape-inventory/SL8500-VOLUMES.html |\
  awk 'NF==10 && $1 ~ /^VO[0-9A-Z][0-9A-Z][0-9][0-9]/ {print $1}' |\
  sort >/tmp/rail-volumes
egrep -v "^$|^<|volser 0[0-9][0-9][0-9][0-9][0-9] media (8MM|DECDLT) attrib (Empty|Occupied)" /diska/tape-inventory/AML2-VOLUMES.html |\
  awk '{print $2}' |\
  sort >/tmp/tower-volumes
awk 'NR>3 && NF==10 && $7!~/null|disk|shelf/ {print $1}' /diska/tape-inventory/VOLUMES_DEFINED |\
  sort >/tmp/vols-defined

# tapes in the PowderHorn 9310, but not in enstore
echo
echo "--------------------------------------------------------------------------------------------------------------------"
echo "Tapes in the PowderHorn 9310 (acs 0, lsm 0 and 1) that are not fully declared to enstore"
comm -23 /tmp/silo-volumes /tmp/vols-defined >/tmp/silo-not-enstore
fgrep -f /tmp/silo-not-enstore /diska/tape-inventory/STK-VOLUMES.html

# tapes in the StreamLine 8500, but not in enstore
echo
echo "--------------------------------------------------------------------------------------------------------------------"
echo "Tapes in the StreamLine 8500 (acs 0, lsm 0 to 3) that are not fully declared to enstore"
comm -23 /tmp/rail-volumes /tmp/vols-defined >/tmp/rail-not-enstore
fgrep -f /tmp/rail-not-enstore /diska/tape-inventory/SL8500-VOLUMES.html

# tapes in the SDSS AML/2 tower, but not in enstore
# stken has only DLTs in the AML/2
echo
echo "--------------------------------------------------------------------------------------------------------------------"
echo "Tapes in the SDSS AML/2 tower that are not fully declared to enstore"
comm -23 /tmp/tower-volumes /tmp/vols-defined >/tmp/tower-not-enstore
fgrep -f /tmp/tower-not-enstore /diska/tape-inventory/AML2-VOLUMES.html

#echo
#echo "--------------------------------------------------------------------------------------------------------------------"
#echo "Tapes not in any category"
#egrep -v "^$|^<|DG [0-9][0-9][0-9]" /diska/tape-inventory/STK-VOLUMES.html |grep -v "        0, [01],"

# tapes in enstore, but not in the robots
echo
echo "--------------------------------------------------------------------------------------------------------------------"
echo "Tapes declared to enstore that are not in the SL8500, the Public or CMS silos, or the SDSS tower"
sort -mu /tmp/silo-volumes /tmp/rail-volumes /tmp/tower-volumes >/tmp/robot-volumes
comm -23 /tmp/vols-defined /tmp/robot-volumes >/tmp/enstore-not-robot
fgrep -f /tmp/enstore-not-robot /diska/tape-inventory/VOLUMES_DEFINED

# tapes in a silo and the tower, whether in enstore or not, ie, duplicate names
echo
echo "--------------------------------------------------------------------------------------------------------------------"
echo "Tapes that are in both a Public or CMS silo and the SDSS tower"
sort -m /tmp/silo-volumes /tmp/tower-volumes | uniq -d | while read vol; do
  grep $vol /diska/tape-inventory/VOLUMES_DEFINED /diska/tape-inventory/STK-VOLUMES.html /diska/tape-inventory/AML2-VOLUMES.html
done

echo
echo "--------------------------------------------------------------------------------------------------------------------"
echo "Tapes in NOACCESS or NOTALLOWED state"
awk 'NR>3 && NF==10 && $3!~/none/ && $4!~/migrated/' /diska/tape-inventory/VOLUMES_DEFINED

echo
echo "--------------------------------------------------------------------------------------------------------------------"
echo "Tapes in invalid library"
libs=`tr '\n' ' ' </tmp/valid-library`
echo "Valid libraries are: $libs"
awk -v Libs="$libs" 'BEGIN {$0=Libs; for (i=1; i<=NF; i++) libs[$i]=i}
		     NR>3 && NF==10 && $NF!~/^test\.[[:print:]]*\.[[:print:]]*/ &&
		     $7!~/null|disk|shelf/ && !($7 in libs)' /diska/tape-inventory/VOLUMES_DEFINED
echo
echo "--------------------------------------------------------------------------------------------------------------------"


elif [ $gang = "d0en" ]; then

# d0en silos are acs 1 & lsm 0,1

# for "query drive" (ACSLS 6), each line in the silo inventory is in one of four formats:
#   vol   home		acs, lsm, panel, row, col	type
#   vol   in drive	acs, lsm, panel, drive		type
#   vol   in transit	acs, lsm, panel, row, col	type
#   vol   in transit	acs, lsm, panel, drive		type
# where type is one of STK2P, STK2W
#
# for "display" (ACSLS 7), each line in the silo inventory has ten fields:
#   Vol_id  Acs  Lsm  Panel  Row  Column  Pool   Status    Media     Type
# where
#   Status is one of dismount, eject, enter, mount, home, in_drive, move, missing, absent, ejected
#   Media is one of STK2P, STK2W
#   Type is one of data, clean
#
# each line in the tower inventory is in this format:
# volser xxxnnn[L1] media 3480 attrib {Empty|Ejected|Mounted|Occupied}
#
# all lines of enstore inventory have ten fields, in this format:
#   vol   avail   system_inhibit   user_inhibit   library   wp_status	mounts   volume_family
# where each inhibit takes two fields (including parentheses)
#
# there should be no deleted volumes in VOLUMES_DEFINED

egrep -v "^$|^<|DG [0-9][0-9][0-9]" /diska/tape-inventory/STK-VOLUMES.html |\
  awk 'NF==10 || /         1, [01],/ {print $1}' |\
  sort >/tmp/silo-volumes
egrep -v "^$|^<|DG [0-9][0-9][0-9]" /diska/tape-inventory/SL8500-VOLUMES.html |\
  awk 'NF==10 && $1 == /^PR[0-9A-Z][0-9A-Z][0-9][0-9]/ {print $1}' |\
  sort >/tmp/rail-volumes
egrep -v "^$|^<|volser 0[0-9][0-9][0-9][0-9][0-9] media (8MM|3480) attrib (Empty|Occupied)" /diska/tape-inventory/AML2-VOLUMES.html |\
  awk '{print $2}' |\
  sort >/tmp/tower-volumes
awk 'NR>3 && NF==10 && $7!~/null|disk|shelf/ {print $1}' /diska/tape-inventory/VOLUMES_DEFINED |\
  sort >/tmp/vols-defined

# tapes in the PowderHorn 9310, but not in enstore
echo
echo "--------------------------------------------------------------------------------------------------------------------"
echo "Tapes in the PowderHorn 9310 (acs 1, lsm 0 and 1) that are not fully declared to enstore"
comm -23 /tmp/silo-volumes /tmp/vols-defined >/tmp/silo-not-enstore
fgrep -f /tmp/silo-not-enstore /diska/tape-inventory/STK-VOLUMES.html

# tapes in the StreamLine 8500, but not in enstore
echo
echo "--------------------------------------------------------------------------------------------------------------------"
echo "Tapes in the StreamLine 8500 (acs 0, lsm 0 to 3) that are not fully declared to enstore"
comm -23 /tmp/rail-volumes /tmp/vols-defined >/tmp/rail-not-enstore
fgrep -f /tmp/rail-not-enstore /diska/tape-inventory/SL8500-VOLUMES.html

# tapes in the D0 AML/2 tower, but not in enstore
# d0en has only LTOs in the ADIC
echo
echo "--------------------------------------------------------------------------------------------------------------------"
echo "Tapes in the D0 tower that are not fully declared to enstore"
comm -23 /tmp/tower-volumes /tmp/vols-defined >/tmp/tower-not-enstore
fgrep -f /tmp/tower-not-enstore /diska/tape-inventory/AML2-VOLUMES.html

#echo
#echo "--------------------------------------------------------------------------------------------------------------------"
#echo "Tapes not in any category"
#egrep -v "^$|^<|DG [0-9][0-9][0-9]" /diska/tape-inventory/STK-VOLUMES.html |grep -v "        1, [01],"

# tapes in enstore, but not in the robots
echo
echo "--------------------------------------------------------------------------------------------------------------------"
echo "Tapes declared to enstore that are not in the SL8500, the D0 silos, or the D0 towers"
sort -mu /tmp/silo-volumes /tmp/rail-volumes /tmp/tower-volumes >/tmp/robot-volumes
comm -23 /tmp/vols-defined /tmp/robot-volumes >/tmp/enstore-not-robot
fgrep -f /tmp/enstore-not-robot /diska/tape-inventory/VOLUMES_DEFINED

# tapes in a silo and the tower, whether in enstore or not, ie, duplicate names
echo
echo "--------------------------------------------------------------------------------------------------------------------"
echo "Tapes that are in both a D0 silo and the D0 tower"
sort -m /tmp/silo-volumes /tmp/tower-volumes | uniq -d | while read vol; do
  grep $vol /diska/tape-inventory/VOLUMES_DEFINED /diska/tape-inventory/STK-VOLUMES.html /diska/tape-inventory/AML2-VOLUMES.html
done

echo
echo "--------------------------------------------------------------------------------------------------------------------"
echo "Tapes in NOACCESS or NOTALLOWED state"
awk 'NR>3 && NF==10 && $3!~/none/ && $4!~/migrated/' /diska/tape-inventory/VOLUMES_DEFINED

echo
echo "--------------------------------------------------------------------------------------------------------------------"
echo "Tapes in invalid library"
libs=`tr '\n' ' ' </tmp/valid-library`
echo "Valid libraries are: $libs"
awk -v Libs="$libs" 'BEGIN {$0=Libs; for (i=1; i<=NF; i++) libs[$i]=i}
		     NR>3 && NF==10 && $NF!~/^test\.[[:print:]]*\.[[:print:]]*/ &&
		     $7!~/null|disk|shelf/ && !($7 in libs)' /diska/tape-inventory/VOLUMES_DEFINED
echo
echo "--------------------------------------------------------------------------------------------------------------------"


elif [ $gang = "cdfen" ]; then

# cdfen 9310 silos are acs 0 & lsm 0,1
# cdfen 8500 rails are acs 0 & lsm 0-3

# for "query drive" (ACSLS 6), each line in the silo inventory is in one of four formats:
#   vol   home		acs, lsm, panel, row, col	type
#   vol   in drive	acs, lsm, panel, drive		type
#   vol   in transit	acs, lsm, panel, row, col	type
#   vol   in transit	acs, lsm, panel, drive		type
# where type is one of STK2P, STK2W
#
# for "display" (ACSLS 7), each line in the silo inventory has ten fields:
#   Vol_id  Acs  Lsm  Panel  Row  Column  Pool   Status    Media     Type
# where
#   Status is one of dismount, eject, enter, mount, home, in_drive, move, missing, absent, ejected
#   Media is one of STK2P, STK2W
#   Type is one of data, clean
#
# all lines of enstore inventory have ten fields, in this format:
#   vol   avail   system_inhibit   user_inhibit   library   wp_status	mounts   volume_family
# where each inhibit takes two fields (including parentheses)
#
# there should be no deleted volumes in VOLUMES_DEFINED

egrep -v "^$|^<|DG [0-9][0-9][0-9]" /diska/tape-inventory/STK-VOLUMES.html |\
  awk 'NF==10 || /         0, [01],/ {print $1}' |\
  sort >/tmp/silo-volumes
egrep -v "^$|^<|DG [0-9][0-9][0-9]" /diska/tape-inventory/SL8500-VOLUMES.html |\
  awk 'NF==10 && $1 == /^IA[0-9A-Z][0-9A-Z][0-9][0-9]/ {print $1}' |\
  sort >/tmp/rail-volumes
awk 'NR>3 && NF==10 && $7!~/null|disk|shelf/ {print $1}' /diska/tape-inventory/VOLUMES_DEFINED |\
  sort >/tmp/vols-defined

# tapes in the PowderHorn 9310, but not in enstore
echo
echo "--------------------------------------------------------------------------------------------------------------------"
echo "Tapes in the PowderHorn 9310 (acs 0, lsm 0 and 1) that are not fully declared to enstore"
comm -23 /tmp/silo-volumes /tmp/vols-defined >/tmp/silo-not-enstore
fgrep -f /tmp/silo-not-enstore /diska/tape-inventory/STK-VOLUMES.html

# tapes in the StreamLine 8500, but not in enstore
echo
echo "--------------------------------------------------------------------------------------------------------------------"
echo "Tapes in the StreamLine 8500 (acs 0, lsm 0 to 3) that are not fully declared to enstore"
comm -23 /tmp/rail-volumes /tmp/vols-defined >/tmp/rail-not-enstore
fgrep -f /tmp/rail-not-enstore /diska/tape-inventory/SL8500-VOLUMES.html

#echo
#echo "--------------------------------------------------------------------------------------------------------------------"
#echo "Tapes not in any category"
#egrep -v "^$|^<|DG [0-9][0-9][0-9]" /diska/tape-inventory/STK-VOLUMES.html |grep -v "        0, [01],"

# tapes in enstore, but not in the robots
echo
echo "--------------------------------------------------------------------------------------------------------------------"
echo "Tapes declared to enstore that are not in the SL8500 or the CDF silos"
sort -mu /tmp/silo-volumes /tmp/rail-volumes >/tmp/robot-volumes
comm -23 /tmp/vols-defined /tmp/robot-volumes >/tmp/enstore-not-robot
fgrep -f /tmp/enstore-not-robot /diska/tape-inventory/VOLUMES_DEFINED

echo
echo "--------------------------------------------------------------------------------------------------------------------"
echo "Tapes in NOACCESS or NOTALLOWED state"
awk 'NR>3 && NF==10 && $3!~/none/ && $4!~/migrated/' /diska/tape-inventory/VOLUMES_DEFINED

echo
echo "--------------------------------------------------------------------------------------------------------------------"
echo "Tapes in invalid library"
libs=`tr '\n' ' ' </tmp/valid-library`
echo "Valid libraries are: $libs"
awk -v Libs="$libs" 'BEGIN {$0=Libs; for (i=1; i<=NF; i++) libs[$i]=i}
		     NR>3 && NF==10 && $NF!~/^test\.[[:print:]]*\.[[:print:]]*/ &&
		     $7!~/null|disk|shelf/ && !($7 in libs)' /diska/tape-inventory/VOLUMES_DEFINED
echo
echo "--------------------------------------------------------------------------------------------------------------------"

fi

date
