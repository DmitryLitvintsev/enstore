#!/bin/sh -u

if [ "${1:-}" = "-x" ]; then set -xv; shift; fi

usage() { echo "Usage: login as enstore to d0ensrv4, stkensrv4, or cdfensrv4"
	  echo "       enter `basename $0`"
	}

[ "$USER" != enstore ] && usage && exit 1

node=`hostname -s`

case $node in
  stkensrv4)
     icap="0,0,0"
     ocap="0,0,0"
     sun=fntt
     ;;
  d0ensrv4)
     icap="1,0,0"
     ocap="1,1,0"
     sun=fntt
     /usr/bin/rsh $sun -l acsss "echo set cap mode automatic $icap | bin/cmd_proc -l -q 2>/dev/null"
     ;;
  cdfensrv4)
     icap="0,1,0"
     ocap="0,0,0"
     sun=fntt2
     /usr/bin/rsh $sun -l acsss "echo set cap mode automatic $icap | bin/cmd_proc -l -q 2>/dev/null"
     ;;
  *) usage
     exit 1
     ;;
esac

output=/tmp/`basename $0`.output

work=/write_protect_work
if [ ! -d $work ]; then
  echo `date` ERROR. $work does not exist
  exit 1
fi

cd $work

for i in `ls -vI \*.\*`; do
  t0=`date  +'%s'`
  . $i |tee $output 2>&1
  echo
  echo
  case $node in
    stk*)
      /usr/bin/rsh $sun -l acsss "echo set cap mode automatic $icap | bin/cmd_proc -l -q 2>/dev/null"
      echo
      echo
      /bin/echo -n "Press Enter when all tapes have been loaded with tab in write-protect mode"
      read ans
      while /bin/true; do
	cap=`/usr/bin/rsh $sun -l acsss "echo q cap $icap | bin/cmd_proc -l -q 2>/dev/null"`
	capstate=`echo $cap | sed -e 's#.*automatic ##' | cut -f1 -d\ `
	if [ "$capstate" = "available" ]; then break; fi
	echo `date` Waiting for cap to be unloaded.
	sleep 5
      done
      /usr/bin/rsh $sun -l acsss "echo set cap mode manual $icap | bin/cmd_proc -l -q 2>/dev/null"
      echo
      echo
      ;;
  esac
  t1=`date  +'%s'`
  delta=`expr $t1 - $t0`
  deltam=`expr $delta / 60`
  deltas=`expr $delta % 60`
  echo That cycle took $deltam minutes $deltas seconds.
  /bin/echo -n "Were all of these steps successful [y/n]? "
  if read ans && expr "$ans" : '[Yy]' >/dev/null ; then
     echo "... success acknowledged"
     mv $i ${i}.done
  else
     echo "... failure acknowledged"
     mv $i ${i}.fail
  fi
  echo
  echo
  rem=`ls -vI \*.\* | wc -l`
  /bin/echo -n "There are `expr $rem` groups remaining.  Do another [y/n]? "
  if read ans && expr "$ans" : '[Yy]' >/dev/null ; then
     continue
  else
     break
  fi
done

case $node in
  d0*|cdf*)
    while /bin/true; do
      cap=`/usr/bin/rsh $sun -l acsss "echo q cap $icap | bin/cmd_proc -l -q 2>/dev/null"`
      capstate=`echo $cap | sed -e 's#.*automatic ##' | cut -f1 -d\ `
      if [ "$capstate" = "available" ]; then break; fi
      echo `date` Waiting for cap to be unloaded.
      sleep 5
    done
    /usr/bin/rsh $sun -l acsss "echo set cap mode manual $icap | bin/cmd_proc -l -q 2>/dev/null"
    ;;
esac
