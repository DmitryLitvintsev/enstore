#!/bin/sh

node=`uname -n| sed -e 's/\([^\.]\)\..*/\1/'`

case node in 
    stk*) icap="0,0,0"
          ocap="0,0,0"
	  sun=fntt
          ;;
    d0*)  icap="1,1,0"
          ocap="1,0,0"
	  sun=fntt
          /usr/bin/rsh $sun -l acsss "echo set cap mode automatic $icap |/export/home/ACSSS/bin/cmd_proc >/dev/null 2>/dev/null"
          ;;
    cdf*) icap="0,1,0"
          ocap="0,0,0"
	  sun=fntt2
          /usr/bin/rsh $sun -l acsss "echo set cap mode automatic $icap |/export/home/ACSSS/bin/cmd_proc >/dev/null 2>/dev/null"
          ;;
       *) echo `date` DO NOT know CAP
          icap="0,0,0"
	  ocap="0,0,0"
	  sun=fntt
esac

output=/tmp/write_tab.output

work=/diska/write_protect_work
if [ ! -d $work ]; then
   echo `date` ERROR. $work does not exist
   exit 1
fi

for i in $work/*; do
  t0=`date  +'%s'`
  . $i |tee $output 2>&1
  echo 
  echo
  case node in 
    stk*)
      /usr/bin/rsh $sun -l acsss "echo set cap mode automatic $icap |/export/home/ACSSS/bin/cmd_proc >/dev/null 2>/dev/null"
      echo 
      echo 
      /bin/echo -n "Push Enter when all tapes have been loaded with tab in write-protect mode "
      read ans
      while /bin/true; do 
        cap=`/usr/bin/rsh $sun -l acsss "echo q cap $icap |/export/home/ACSSS/bin/cmd_proc 2>/dev/null"`
        capstate=`echo $cap  | sed -e 's#.*automatic ##' | cut -f1 -d\ `
        if [ "$capstate" = "available" ]; then break; fi
        echo `date` waiting for cap to be unloaded.
        sleep 5
      done
      /usr/bin/rsh $sun -l acsss "echo set cap mode manual $icap |/export/home/ACSSS/bin/cmd_proc >/dev/null 2>/dev/null"
      echo 
      echo
      ;;
  esac
  t1=`date  +'%s'`
  delta=`expr $t1 - $t0`
  deltam=`expr $delta / 60`
  smin=`expr $deltam \* 60`
  deltas=`expr $delta - $smin`
  echo That cycle took $deltam minutes $deltas sec
  /bin/echo -n "Were all of these steps successful [y or n]? "
  read ans
  if [ $? -eq 0 ] &&  expr "$ans" : '[Yy]' >/dev/null ; then
     echo "... success acknowledged"
     rm -f $i >/dev/null 2>/dev/null
  else
     echo "... failure noted"
  fi
  echo
  echo
  left=`ls -1 $work|wc|awk '{print $1}'`
  /bin/echo -n "There are $left groups left to do.  Another [yn]? "
  read ans
  if [ $? -eq 0 ] &&  expr "$ans" : '[Yy]' >/dev/null ; then
     x=1
  else
     break
  fi
done

case node in 
    d0*|cdf*)
      /usr/bin/rsh $sun -l acsss "echo set cap mode manual $icap |/export/home/ACSSS/bin/cmd_proc >/dev/null 2>/dev/null"
      ;;
esac
