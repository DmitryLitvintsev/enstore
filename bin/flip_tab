#!/bin/sh

output=/tmp/write_tab.output

sun=fntt

work=/diska/write_protect_work
if [ ! -d $work ]; then
   echo `date` ERROR. $work does not exist
   exit 1
fi

for i in $work/*; do
  . $i |tee $output 2>&1
  echo 
  echo
# /usr/bin/rsh $sun -l acsss "echo enter 0,0,0 |/export/home/ACSSS/bin/cmd_proc" 
  /usr/bin/rsh $sun -l acsss "echo set cap mode automatic 0,0,0 |/export/home/ACSSS/bin/cmd_proc"
  echo 
  /bin/echo -n "Push Enter when all tapes have been loaded with tab in write-protect mode"
  read ans
  while /bin/true; do 
    cap=`/usr/bin/rsh $sun -l acsss "echo q cap 0,0,0 |/export/home/ACSSS/bin/cmd_proc 2>/dev/null"`
    capstate=`echo $cap  | sed -e 's#.*automatic ##' | cut -f1 -d\ `
    if [ "$capstate" = "available" ]; then break; fi
    echo `date` waiting for cap to be unloaded: $capstate
    sleep 15
  done
  /usr/bin/rsh $sun -l acsss "echo set cap mode manual 0,0,0 |/export/home/ACSSS/bin/cmd_proc"
  echo 
  echo
  /bin/echo -n "Were all of these steps successful [y or n]? "
  read ans
  if [ $? -eq 0 ] &&  expr "$ans" : '[Yy]' >/dev/null ; then
     echo "... success acknowledged"
     rm -f $i >/dev/null 2>/dev/null
  else
     echo "... failure noted"
  fi
  echo
  echo
  /bin/echo -n "Another [yn]? "
  read ans
  if [ $? -eq 0 ] &&  expr "$ans" : '[Yy]' >/dev/null ; then
     x=1
  else
     break
  fi
done
