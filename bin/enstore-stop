#!/bin/sh
set -u  # force better programming and ability to use check for not set
if [ "${1:-}" = "-x" ] ; then set -xv; shift; fi

# bin/$RCSfile$   $Revision$
# stop enstore processes on the current node

me=`whoami`
PID_DIR=/tmp/enstore/$me

# NOTE: some options (w/ or w/o args) are currently provided just for restart
# (compatible with start)
opts_w_args='xterm|just'
USAGE="`basename $0`: [--{$opts_w_args} <arg>]"
while opt=`expr "${1-}" : '--\(.*\)'`;do
    shift
    eval "case \$opt in
    \\?) echo \"$USAGE\"; exit 0;;
    $opts_w_args)
        if [ $# = 0 ];then echo option $opt requires argument; exit 1; fi
        eval opt_\$opt=\"'\$1'\";shift ;;
    *)  echo \"invalid option: \$opt\"; exit 1;;
    esac"
done


turnoff() { for pid in $1; do
                if [ "$pid" = "$1" ] ; then echo "No $2 running"; break; fi
                pidkill $pid
            done; }

turnoff_s() { for pid in $1; do
                if [ "$pid" = "$1" ] ; then echo "No $2 running"; break; fi
                pidkill_s $pid
            done; }

if [ "${opt_just-}" = "" -o "`echo ${opt_just-}|grep adm`" ];then
    turnoff_s "$PID_DIR/`uname -n`-db_*_pids"            "databases"
    turnoff "$PID_DIR/`uname -n`-admin*pids"           "admin"
fi
if [ "${opt_just-}" = "" -o "`echo ${opt_just-}|grep inq`" ];then
    turnoff "$PID_DIR/`uname -n`-inquisitor*pids"      "inquisitor"
fi
if [ "${opt_just-}" = "" -o "`echo ${opt_just-}|grep fil`" ];then
    turnoff "$PID_DIR/`uname -n`-file_clerk*pids"      "file_clerk"
fi
if [ "${opt_just-}" = "" -o "`echo ${opt_just-}|grep vol`" ];then
    turnoff "$PID_DIR/`uname -n`-volume_clerk*pids"    "volume_clerk"
fi
if [ "${opt_just-}" = "" -o "`echo ${opt_just-}|grep mov`" ];then
    theMachine=`hostname`
    host=`expr $theMachine : '\([^.]*\)'`
    movers=`conf.sh "" 2 2 | grep "mover:$host"`
    if [ "$movers" ];then
        for ll in $movers;do
            name=`expr "$ll" : '\([^:]*\)'`
            echo "Stopping $name"
            node=`expr "$ll" : '[^:]*:\([^:]*\)'`
            port=`expr "$ll" : '.*:\(.*\)'`
            udp_sendWaitReply-withTimeout.sh $node $port 3 --work shutdown >/dev/null
        done
    else
        echo "No movers running"
    fi
    #turnoff_s "$PID_DIR/`uname -n`-mover*pids"           "movers"
fi
if [ "${opt_just-}" = "" -o "`echo ${opt_just-}|grep med`" ];then
    turnoff "$PID_DIR/`uname -n`-media_changer*pids"   "media_changers"
fi
if [ "${opt_just-}" = "" -o "`echo ${opt_just-}|grep lib`" ];then
    turnoff "$PID_DIR/`uname -n`-library_manager*pids" "library manager"
fi
if [ "${opt_just-}" = "" -o "`echo ${opt_just-}|grep conf`" ];then
    turnoff "$PID_DIR/`uname -n`-configuration*pids"   "configuration server"
fi
if [ "${opt_just-}" = "" -o "`echo ${opt_just-}|grep log`" ];then
    turnoff "$PID_DIR/`uname -n`-log_server*pids"      "log server"
fi

#    turnoff "$PID_DIR/`uname -n`-*pids"                "what else"

exit
