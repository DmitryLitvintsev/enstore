#!/bin/sh
#set -u  # force better programming and ability to use check for not set
if [ "${1:-}" = "-x" ] ; then set -xv; shift; fi

# Starts enstore after a machine boots

timeout=4
output=/home/enstore/`hostname`.startup
touch $output
chown enstore.enstore $output
estat=0

case "$1" in

  start)
        echo Starting enstore 2>&1 | tee /dev/console >>$output

	find /tmp/enstore -name "*pids" -exec rm {} \;
	find /tmp/enstore -name "trace*key" -exec rm {} \;

        . /usr/local/etc/setups.sh
        setup enstore 

        n1=`echo $ENSTORE_CONFIG_HOST | sed -e 's/\([^\.]\)\..*/\1/'`
        n2=`uname -n | sed -e 's/\([^\.]\)\..*/\1/'`

	# if running not on config node
        if [ "$n1" != "$n2" ]; then
        #if [ "$n1" == "$n2" ]; then
            for server in config log alarm; do
	      echo "`date`: checking if $server is alive"  2>&1 | tee /dev/console >>$output
              enstore $server --alive --timeout=$timeout --retries=2 > /dev/null 2>&1
              estat=$?
	      echo "`date`:  ... status returned=$estat" 2>&1 | tee /dev/console >>$output
              if [ $estat -ne 0 ] ; then
                echo "`date`: $server not responding, can not continue..." 2>&1 | tee /dev/console >>$output
                break
              fi
            done
        fi
        if [ $estat -eq 0 ]; then
          # we should be enstore when we start this up (at least not root) if we are a server
          if [ "`whoami`" = "root" -a `echo $n2 | grep -c mvr` -eq 0 ] ; then
	    echo "`date`: su-ing to enstore and doing an enstore Estart $n2" 2>&1 | tee /dev/console >>$output
            su enstore -c ". /usr/local/etc/setups.sh ; setup enstore; enstore Estart $n2"  
          else
            echo "`date`: doing enstore Estart $n2" 2>&1 | tee /dev/console >>$output
            enstore Estart $n2 
          fi
       
        fi
        ;;

  stop)
        echo Stopping enstore 2>&1 | tee /dev/console >>$output
        . /usr/local/etc/setups.sh
        setup enstore
        enstore stop
        ;;

  install)
        . /usr/local/etc/setups.sh
        setup enstore
        x=/etc/rc.d/init.d/enstore-boot
        rm -f $x; cp $ENSTORE_DIR/bin/enstore-boot $x
        cd /etc/rc.d/rc3.d
        x=S99zzzenstore-boot
        rm -f $x; ln -s ../init.d/enstore-boot $x
        cd /etc/rc.d/rc6.d
        x=K01aaaenstore-boot
        rm -f $x; ln -s ../init.d/enstore-boot $x
        ;;
  *)
        echo "Usage: /etc/rc.d/init.d/enstore-boot {start|stop}"
        estat=1
        ;;
esac

exit $estat
