#!/bin/sh
set -u  # force better programming and ability to use check for not set
if [ "${1:-}" = "-x" ] ; then set -xv; shift; fi

# bin/$RCSfile$  $Revision$
# returns rate from a mover

opts_wo_args=''
opts_w_args='update_delay|udp_timeout|udp_retries'
USAGE="`basename $0` mover_name  [--{$opts_w_args} <arg>] [--{$opts_wo_args}]"
if [ $# -lt 1 ];then
    echo "$USAGE"
    exit 1
else
    mover=$1
    shift 1
fi
while opt=`expr "${1-}" : '--\(.*\)'`;do
    shift
    eval "case \$opt in
    \\?) echo \"$USAGE\"; exit 0;;
#uncomment next 2 lines if we get some opts_wo_args
#NO#$opts_wo_args)
#NO#    eval opt_\$opt=1;;
    $opts_w_args)
        if [ $# = 0 ];then echo option $opt requires argument; exit 1; fi
        eval opt_\$opt=\"'\$1'\";shift ;;
    *)  echo \"invalid option: \$opt\"; exit 1;;
    esac"
done

nodes=`conf.sh`
host=`echo "$nodes" | grep -i $mover | grep mover| cut -f2 -d:`
port=`echo "$nodes" | grep -i $mover | grep mover| cut -f3 -d:`
mvr=`echo "$nodes" | grep -i $mover | grep mover| cut -f1 -d:| cut -f1 -d.`
#echo $host
#echo $port

if [ -z "${host-}" -o -z "${port-}" ] ; then
  echo $mover not found in
  echo "$nodes"
  exit 1
fi

python -c '
import sys
import time
import traceback
import udp_client
import errno
u = udp_client.UDPClient()
bytes=-1
t=-1
nt=-1.
while 1==1:
  try:
    s = u.send( {"work":"status"}, ("'$host'",'$port'), '${opt_udp_timeout:-3}', '${opt_udp_retries:-2}' )
    nt=time.time()
    #print "s=",s
    sts=0
    rate = -1.
    moved = 0.
    state = "unknown"
    if s["state"]=="idle":
      rate = 0.
      moved = 0
      state = "idle"
    elif s["mode"]=="w" and s["state"]=="busy":
      if t==-1 or bytes==-1:
        rate = 0.
        moved = 0
        state = "rate_init"
      else:
        rate = (s["wr_bytes"]-bytes)/(nt-t)/1024./1024.
        moved = s["wr_bytes"]
        state = "writing"
        if rate<0.:
	  rate = 0.
      bytes=s["wr_bytes"]
    print "%.3f %.3f %.10i %9.9s %s %s %i %s" % (nt, rate, moved, state, "'$mvr'","'$host'",'$port', time.strftime("%c",time.localtime(nt)))
    t=nt
    time.sleep('${opt_update_delay:-2}')
  except errno.errorcode[errno.ETIMEDOUT]:
    rate = 0.
    moved = 0
    state = "timeout"
    print "%.3f %.3f %.10i %.9s %s %s %i %s" % (nt, rate, moved, state, "'$mvr'","'$host'",'$port', time.strftime("%c",time.localtime(nt)))
  except:
    traceback.print_exc()
    sts=1
    break
del u
sys.exit( sts )
'
