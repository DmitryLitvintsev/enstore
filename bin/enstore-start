#!/bin/sh

if [ "${1:-}" = "-x" ] ; then set -xv; shift; fi
set -u  # force better programming and ability to use check for not set

. $ENSTORE_DIR/bin/defaults

libraries="activelibrary red50library"
media_changers="STK.media_changer RDD.media_changer"
movers="fd0.mover stk0.mover"

# ok, this is terrible - but let's start always start up in the etc area so files are created there
place=`pwd`
cd $ENSTORE_DIR/etc

# the configuration server needs to be the 1st thing started
echo "Starting configuration server on $config_host, port $config_port, using file $config_file"
python $ENSTORE_DIR/src/configuration_server.py --config_host=$config_host --config_port=$config_port --config_file=$config_file &
echo $! >> `uname -n`-configuration_pids
sleep 1

# now check to see if it is really running
python $ENSTORE_DIR/src/configuration_client.py --config_host $config_host --config_port $config_port
if [ $? -ne 0 ] ; then
    echo "...configuration error. can not continue..."
    cd $place
    exit 1
fi

# volume clerk
echo "Starting volume clerk"
python $ENSTORE_DIR/src/volume_clerk.py    --config_host $config_host --config_port $config_port &
echo $! >> `uname -n`-volume_clerk_pids

# file clerk
echo "Starting file clerk"
python $ENSTORE_DIR/src/file_clerk.py      --config_host $config_host --config_port $config_port &
echo $! >> `uname -n`-file_clerk_pids

# library manager
for i in $libraries; do
  echo "Starting library manager: $i"
  python $ENSTORE_DIR/src/library_manager.py --config_host $config_host --config_port $config_port $i &
  echo $! >> `uname -n`-library_manager_pids
done

# stk media changer
for i in $media_changers; do
  echo "Starting $i media changer"
  python $ENSTORE_DIR/src/media_changer.py --config_host $config_host --config_port $config_port $i &
  echo $! >> `uname -n`-media_changer_pids
done

# mover: raw disk mover
for i in $movers; do
  echo "Starting $i Mover"
  python $ENSTORE_DIR/src/mover.py          --config_host $config_host --config_port $config_port $i &
  echo $! >> `uname -n`-mover_pids
done

# really need to add a check to make sure they are working
sleep 1

cd $place
