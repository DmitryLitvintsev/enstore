#!/bin/sh
set -u  # force better programming and ability to use check for not set
if [ "${1:-}" = "-x" ] ; then set -xv; shift; fi

# bin/$RCSfile$   $Revision$
# start enstore processes on the current node

me=`whoami`
PID_DIR=/tmp/enstore/$me
if [ ! -d $PID_DIR ]; then
    mkdir -p $PID_DIR
fi

opts_wo_args='ping|nocheck'
opts_w_args='xterm|just'
USAGE="`basename $0`: [--{$opts_w_args} <arg>] [--{$opts_wo_args}]"
while opt=`expr "${1-}" : '--\(.*\)'`;do
    shift
    eval "case \$opt in
    \\?) echo \"$USAGE\"; exit 0;;
    $opts_wo_args)
        eval opt_\$opt=1;;
    $opts_w_args)
        if [ $# = 0 ];then echo option $opt requires argument; exit 1; fi
        eval opt_\$opt=\"'\$1'\";shift ;;
    *)  echo \"invalid option: \$opt\"; exit 1;;
    esac"
done

# this works for the case where opt_just is null
opt_just_ere=`echo ${opt_just-} | sed -e 's/ /|/g' -e 's/,/|/g'`
if [ "$opt_just_ere" = "" ];then opt_just_ere=".*";fi

place=`pwd`
cd $PID_DIR

local_host=`hostname`
enstore_start_config=0     # new default
eful=0 lful=0
if expr "$ENSTORE_CONFIG_HOST" : '.*\.' >/dev/null;then eful=1; fi
if expr "$local_host" : '.*\.' >/dev/null;         then lful=1; fi

if   [ $eful = 1 -a $lful = 0 ];then
    local_host=`nslookup $local_host | sed -e '/Name.*/ !d' -e 's/Name: *//'`
elif [ $eful = 0 -a $lful = 1 ];then
    ENSTORE_CONFIG_HOST=`nslookup $local_host | sed -e '/Name.*/ !d' -e 's/Name: *//'`
fi

if [ $local_host = $ENSTORE_CONFIG_HOST ];then
    enstore_start_config=1
fi

timeout=1
tries=10

# function to redirect input/output when there is not a controlling terminal
output() { tty -s
           if [ $? -ne 0 ] ; then
             if [ -z "${1-}" ] ; then
               echo "< /dev/null > /dev/null 2>&1"
             else
               echo " < /dev/null > $1.out 2>&1"
             fi
           fi
         }

# function to check if server is up, exits if it is not
check_server()
{
    if [ `echo $1 | grep -c config` -eq 0 ]; then
      xnode=`echo "$nodeplus_servers" | grep $1 | cut -d: -f2`
      xport=`echo "$nodeplus_servers" | grep $1 | cut -d: -f3`
    else
      xnode=$ENSTORE_CONFIG_HOST
      xport=$ENSTORE_CONFIG_PORT
    fi
    if [ -n "${2-}" ] ; then
       echo Checking $1 on $xnode $xport $local_host
    fi  
    alv=`udp_sendWaitReply-withTimeout.sh $xnode $xport $timeout --tries $tries`
    if [ $? -ne 0 ] ; then
        echo "   ...$1 not reachable..."
        exit 1
    elif [ -n "${2-}" -a `echo $local_host | grep -ic $xnode` -ne 0 ]; then 
       # put the pid (maybe more than once, doesn't matter) into pid file
       echo $alv | sed -e 's/.*pid.: //' -e 's/,.*//'  >> $2
       echo $alv
    fi
}


start_db_daemons(){

    enstore_db=`udp_sendWaitReply-withTimeout.sh $ENSTORE_CONFIG_HOST $ENSTORE_CONFIG_PORT 4 --work lookup --additional_ticket '"lookup":"database"' | cut -d: -f2 | cut -d, -f1 | cut -d\' -f2`
    out=$PID_DIR/db_checkpoint

    if [ ! -e $out ] ; then
        echo "Starting database checkpoint daemon  on `hostname`"
	cmd="db_checkpoint -h $enstore_db  -p 5 `output $out`"
	eval "$cmd &"
        echo $! >> $PID_DIR/`uname -n`-db_daemons_pids	
    fi


    out=$PID_DIR/db_deadlock
    if [ ! -e $out ] ; then
        echo "Starting database deadlock daemon  on `hostname`"
        cmd="db_deadlock -h $enstore_db  -t 1 `output $out`"
        eval "$cmd &"
        echo $! >> $PID_DIR/`uname -n`-db_daemons_pids	
     fi
}

###################################################################################################################################

# the configuration server needs to be the 1st thing started
if [ "${opt_just-}" = "" -o "`echo ${opt_just-}|grep conf`" ];then
    if [ "${opt_ping-}" != 1 -a $enstore_start_config -eq 1 ];then
      if   [ ! "${opt_nocheck-}" ]\
        && udp_sendWaitReply-withTimeout.sh $ENSTORE_CONFIG_HOST $ENSTORE_CONFIG_PORT $timeout >/dev/null
        then
        echo "Configuration Server on $ENSTORE_CONFIG_HOST already started"
      else
        echo "Starting Configuration Server on $ENSTORE_CONFIG_HOST, port $ENSTORE_CONFIG_PORT, using file $ENSTORE_CONFIG_FILE"
        out=$PID_DIR/configuration_server
        rm -f $out
        cmd="python $ENSTORE_DIR/src/configuration_server.py \
            --config_host=$ENSTORE_CONFIG_HOST --config_port=$ENSTORE_CONFIG_PORT --config_file=$ENSTORE_CONFIG_FILE `output $out`"
        if [ "${opt_xterm-}" ] && echo ${opt_xterm-} | egrep 'all|conf' >/dev/null; then
            title="Enstore Config Server"
            eval "xterm -sl 2500 -T \"$title\" -e $cmd &"
        else
            eval "$cmd &"
        fi
        echo $! >> $PID_DIR/`uname -n`-configuration_pids
      fi
    fi

    check_server configuration $PID_DIR/`uname -n`-configuration_pids

fi

###################################################################################################################################

# new defaults
enstore_libraries=
enstore_media_changers=
enstore_movers=
enstore_start_fileclerk=0
enstore_start_volumeclerk=0
enstore_start_log=0

enstore_start_admin=0
enstore_start_inquisitor=0
ENSTORE_CONFIG_HOST=$ENSTORE_CONFIG_HOST;export ENSTORE_CONFIG_HOST
ENSTORE_CONFIG_PORT=$ENSTORE_CONFIG_PORT;export ENSTORE_CONFIG_PORT

# get all the servers for this port and other important servers (file_clerk, volume_clerk, ...)
#note that conf.sh will reset the above vars.
nodeplus_servers=`conf.sh $local_host 3 2`

# check if Configuration Server is up
if [ $? -ne 0 ] ; then
    echo "   ...Configuration Server not reachable..."
    exit 1
fi

# now just isolate the servers for this node
node_servers=`echo "$nodeplus_servers" | grep :$local_host: | sed -e "s/:$local_host//"`

if [ ! "$node_servers" ];then
    #echo try alternate host specification
    if  hh=`expr "$local_host" : '\([^.]*\)\.'`;then
        :
    else
        hh=`nslookup $local_host | sed -e '/Name.*/ !d' -e 's/Name: *//'`
    fi
    nodeplus_servers=`conf.sh $hh 3 2`
    # check if Configuration Server is up
    if [ $? -ne 0 ] ; then
	echo "   ...Configuration Server not reachable..."
	exit 1
    fi

    node_servers=`echo "$nodeplus_servers" | grep :$hh: | sed -e "s/:$hh//"`
fi

for server in $node_servers;do
    if t=`expr "$server" : '\(.*\)[: ]'`;then   #strip off port if it exists
        server=$t
    fi
    case $server in
    *library_manager)
        enstore_libraries="$enstore_libraries $server";;
    *media_changer)
        enstore_media_changers="$enstore_media_changers $server";;
    *mover)
        enstore_movers="$enstore_movers $server";;
    logserver)
        enstore_start_log=1;;
    file_clerk)
        enstore_start_fileclerk=1;;
    volume_clerk)
        enstore_start_volumeclerk=1;;
    inquisitor)
        enstore_start_inquisitor=1;;
    esac
done

###################################################################################################################################

# the logger needs to be next
if [ "${opt_just-}" = "" -o "`echo ${opt_just-}|grep log`" ];then
    if [ "${opt_ping-}" != 1 -a $enstore_start_log -eq 1 ];then
      if   [ ! "${opt_nocheck-}" ]\
        && udp_sendWaitReply-withTimeout.sh $local_host `echo "$node_servers"|grep logserver |sed -e 's/.*://'` $timeout >/dev/null
        then
        echo "Log Server already started"
      else
        echo "Starting Log Server"
        out=$PID_DIR/log_server
        rm -f $out
        cmd="python $ENSTORE_DIR/src/log_server.py --config_host=$ENSTORE_CONFIG_HOST --config_port=$ENSTORE_CONFIG_PORT `output $out`"
        if [ "${opt_xterm-}" ] && echo ${opt_xterm-} | egrep 'all|log' >/dev/null; then
            title="Enstore Log Server"
            eval "xterm -sl 2500 -T \"$title\" -e $cmd &"
        else
            eval "$cmd &"
        fi
        echo $! >> $PID_DIR/`uname -n`-log_server_pids
      fi
    fi

    check_server logserver $PID_DIR/`uname -n`-log_server_pids

fi

###################################################################################################################################

# volume clerk
if [ "${opt_just-}" = "" -o "`echo ${opt_just-}|grep vol`" ];then
    if [ "${opt_ping-}" != 1 -a $enstore_start_volumeclerk -eq 1 ];then
      if   [ ! "${opt_nocheck-}" ]\
        && udp_sendWaitReply-withTimeout.sh $local_host `echo "$node_servers"|grep volume_clerk|sed -e 's/.*://'` $timeout>/dev/null
        then
        echo "Volume Clerk already started"
      else
        start_db_daemons
        echo "Starting Volume Clerk"
        out=$PID_DIR/volume_clerk
        rm -f $out
        cmd="python $ENSTORE_DIR/src/volume_clerk.py --config_host=$ENSTORE_CONFIG_HOST --config_port=$ENSTORE_CONFIG_PORT `output $out`"
        if [ "${opt_xterm-}" ] && echo ${opt_xterm-} | egrep 'all|vol' >/dev/null; then
            title="Enstore Volume Clerk"
            eval "xterm -sl 2500 -T \"$title\" -e $cmd &"
        else
            eval "$cmd &"
        fi
        echo $! >> $PID_DIR/`uname -n`-volume_clerk_pids
      fi
    fi

    check_server volume_clerk $PID_DIR/`uname -n`-volume_clerk_pids 

fi

###################################################################################################################################

# file clerk
if [ "${opt_just-}" = "" -o "`echo ${opt_just-}|grep fil`" ];then
    # check volume clerk file clerk depends on
    check_server volume_clerk ""
    if [ $? -ne 0 ] ; then
	echo "   ...Volume Clerk not reachable..."
	exit 1
    fi
    if [ "${opt_ping-}" != 1 -a $enstore_start_fileclerk = 1 ];then

      if   [ ! "${opt_nocheck-}" ]\
        && udp_sendWaitReply-withTimeout.sh $local_host `echo "$node_servers"|grep file_clerk|sed -e 's/.*://'` $timeout >/dev/null
        then
        echo "File Clerk already started"
      else
        start_db_daemons
        echo "Starting File Clerk"
        out=$PID_DIR/file_clerk
        rm -f $out
        cmd="python $ENSTORE_DIR/src/file_clerk.py --config_host=$ENSTORE_CONFIG_HOST --config_port=$ENSTORE_CONFIG_PORT `output $out`"
        if [ "${opt_xterm-}" ] && echo ${opt_xterm-} | egrep 'all|fil' >/dev/null; then
            title="Enstore File Clerk"
            eval "xterm -sl 2500 -T \"$title\" -e $cmd &"
        else
            eval "$cmd &"
        fi
        echo $! >> $PID_DIR/`uname -n`-file_clerk_pids
      fi
    fi

    check_server file_clerk $PID_DIR/`uname -n`-file_clerk_pids

fi

###################################################################################################################################

# library manager

if [ "${opt_just-}" = "" -o "`echo ${opt_just-}|grep lib`" ];then
    # check volume clerk library manager depends on
    check_server volume_clerk ""
    if [ $? -ne 0 ] ; then
	echo "   ...Volume Clerk not reachable..."
	exit 1
    fi
    for i in $enstore_libraries; do
        do_server=`echo $i | egrep "$opt_just_ere"`
        if [ ! "$do_server" ];then continue; fi

        if [ ! "${opt_ping-}" ];then
            if     [ ! "${opt_nocheck-}" ]\
                && udp_sendWaitReply-withTimeout.sh $local_host `echo "$node_servers"|grep $i|sed -e 's/.*://'` $timeout >/dev/null
                then
                echo "Library Manager already started"
            else
                echo "Starting $i Library Manager"
                out=$PID_DIR/library_manager_$i
                rm -f $out
                cmd="python $ENSTORE_DIR/src/library_manager.py \
                    --config_host=$ENSTORE_CONFIG_HOST --config_port=$ENSTORE_CONFIG_PORT $i `output $out`"
                if [ "${opt_xterm-}" ] && echo ${opt_xterm-} | egrep 'all|lib' >/dev/null; then
                    title="Enstore Library Manager $i"
                    eval "xterm -sl 2500 -T \"$title\" -e $cmd &"
                else
                    eval "$cmd &"
                fi
                echo $! > $PID_DIR/`uname -n`-$i-library_manager_pid
            fi
        fi
	
	check_server $i $PID_DIR/`uname -n`-$i-library_manager_pid

    done
fi

###################################################################################################################################

# media changer
if [ "${opt_just-}" = "" -o "`echo ${opt_just-}|grep med`" ];then
    for i in $enstore_media_changers; do
        do_server=`echo $i | egrep "$opt_just_ere"`
        if [ ! "$do_server" ];then continue; fi

        if [ ! "${opt_ping-}" ];then
            if     [ ! "${opt_nocheck-}" ]\
                && udp_sendWaitReply-withTimeout.sh $local_host `echo "$node_servers"|grep $i|sed -e 's/.*://'` $timeout >/dev/null
                then
                echo "Media Changer already started"
            else
                echo "Starting $i Media Changer"
                out=$PID_DIR/media_changer_$i
                rm -f $out
                cmd="python $ENSTORE_DIR/src/media_changer.py \
                    --config_host=$ENSTORE_CONFIG_HOST --config_port=$ENSTORE_CONFIG_PORT $i `output $out`"
                if [ "${opt_xterm-}" ] && echo ${opt_xterm-} | egrep 'all|med' >/dev/null; then
                    title="Enstore Media Changer $i"
                    eval "xterm -sl 2500 -T \"$title\" -e $cmd &"
                else
                    eval "$cmd &"
                fi
                echo $! >> $PID_DIR/`uname -n`-$i-media_changer_pid
            fi
        fi

	check_server $i $PID_DIR/`uname -n`-$i-media_changer_pid

    done

fi

###################################################################################################################################

# mover
if [ "${opt_just-}" = "" -o "`echo ${opt_just-}|grep mov`" ];then
    # check volume clerk mover depends on
    check_server volume_clerk ""
    if [ $? -ne 0 ] ; then
	echo "   ...Volume Clerk not reachable..."
	exit 1
    fi
    # check file clerk mover depends on
    check_server file_clerk ""
    if [ $? -ne 0 ] ; then
	echo "   ...File Clerk not reachable..."
	exit 1
    fi
    for i in $enstore_movers; do
        do_server=`echo $i | egrep "$opt_just_ere"`
        if [ ! "$do_server" ];then continue; fi

        if [ ! "${opt_ping-}" ];then
            if     [ ! "${opt_nocheck-}" ]\
                && udp_sendWaitReply-withTimeout.sh $local_host `echo "$node_servers"|grep $i|sed -e 's/.*://'` $timeout >/dev/null
                then
                echo "$i Mover already started"
            else
                echo "Starting $i Mover"
                out=$PID_DIR/mover_$i
                rm -f $out
                cmd="python $ENSTORE_DIR/src/mover.py --config_host=$ENSTORE_CONFIG_HOST --config_port=$ENSTORE_CONFIG_PORT $i `output $out`"
                if [ "${opt_xterm-}" ] && echo ${opt_xterm-} | egrep 'all|mov' >/dev/null; then
                    title="Enstore Mover $i"
                    eval "xterm -sl 2500 -T \"$title\" -e $cmd &"
                else
                    eval "$cmd &"
                fi
                echo $! >> $PID_DIR/`uname -n`-$i-mover_pid
            fi
        fi

	check_server $i $PID_DIR/`uname -n`-$i-mover_pid

    done

fi

###################################################################################################################################

# inquisitor
if [ "${opt_just-}" = "" -o "`echo ${opt_just-}|grep inq`" ];then
    if [ "${opt_ping-}" != 1 -a $enstore_start_inquisitor = 1 ];then
      if   [ ! "${opt_nocheck-}" ]\
        && udp_sendWaitReply-withTimeout.sh $local_host `echo "$node_servers"|grep inquisitor|sed -e 's/.*://'` $timeout >/dev/null
        then
        echo "Inquisitor already started"
      else
        echo "Starting Inquisitor"
        out=$PID_DIR/inquisitor
        rm -f $out
        cmd="python $ENSTORE_DIR/src/inquisitor.py --config_host=$ENSTORE_CONFIG_HOST --config_port=$ENSTORE_CONFIG_PORT `output $out`"
        if [ "${opt_xterm-}" ] && echo ${opt_xterm-} | egrep 'all|inq' >/dev/null; then
            title="Enstore Inquisitor"
            eval "xterm -sl 2500 -T \"$title\" -e $cmd &"
        else
            eval "$cmd &"
        fi
        echo $! >> $PID_DIR/`uname -n`-inquisitor_pids
      fi
    fi

    check_server inquisitor $PID_DIR/`uname -n`-inquisitor_pids

fi



###################################################################################################################################

cd $place
