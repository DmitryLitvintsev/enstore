#!/bin/sh
set -u  # force better programming and ability to use check for not set
if [ "${1:-}" = "-x" ] ; then set -xv; shift; fi

# bin/$RCSfile$  $Revision$

ptime() {
python -c '
import time
print time.strftime("%c",time.localtime('$1'))
'
}

if [ -z "${1-}" ] ; then
  # write the output to a sub-directory in the inquisitor's web directory
  output=`conf.sh -k inquisitor | awk '($1 ~ /html_file/) {print $2}' | sed -e "s/'//g" -e "s/,//g"`tape_inventory
  if [ "$output" = "" ]; then exit 2; fi
  if [ ! -d $output ] ; then mkdir -p $output || exit 3; fi
  out=$output/VOLUMES_DEFINED
  if [ -e $out ]; then rm  $out;fi
  echo Date this volume listing was generated: `date` > $out
  # get all the volumes that have been defined
  #vols=`enstore volume --vols | cut -f1 -d\ | grep -v label`
  enstore volume --vols >> $out
  vols=`cat $out | cut -f1 -d\ | egrep -v 'label|Date|\.deleted'`
else
  vols="$1"
  output=""
fi

number=`echo "$vols" | wc -l`


# now loop over them and save the output
count=0
for vol in $vols; do
  count=`expr $count + 1`
  echo "$vol  volume $count of $number"
  finfo=`enstore file --list=$vol`
  vinfo=`enstore volume --vol=$vol`
  la=`echo "$vinfo" | awk '($1 ~ /last_access/) {print $2}'`
  lat="`ptime $la`"
  b=`echo "$vinfo"  | awk '($1 ~ /remaining_bytes/ ) {print $2}' | sed -e 's/L,//g'`
  gb=`echo "$b / 1073741824" | bc`
  si=`echo "$vinfo"  | awk '($1 ~ /system_inhibit/ ) {print $2,$3}' | sed -e "s/'//g" -e "s/,//g"`
  ui=`echo "$vinfo"  | awk '($1 ~ /user_inhibit/ )   {print $2,$3}' | sed -e "s/'//g" -e "s/,//g"`
  if [ "$output" != "" ]; then
    out=$output/$vol
    if [ -e $out ]; then rm  $out;fi
    echo "Volume:            $vol"      >>$out
    echo "Last accessed on:  $lat"      >>$out
    echo "GBytes free:       $gb"       >>$out
    echo "Inhibits:          $si + $ui" >>$out
    echo "Date of this info: `date`"    >>$out
    echo                                >>$out
    echo "$finfo"                       >>$out
    echo                                >>$out
    echo "$vinfo"                       >>$out
  else
    echo "Volume:            $vol"
    echo "Last accessed on:  $lat"
    echo "GBytes free:       $gb"
    echo "Inhibits:          $si + $ui"
    echo "Date of this info  `date`"
    echo
    echo "$finfo"
    echo
    echo "$vinfo"
  fi
done

# clean up the output area
if [ "$output" != "" ]; then
  find $output -daystart -mtime +3 -exec rm -f {} \;
done

