#!/bin/sh
set -u  # force better programming and ability to use check for not set
if [ "${1:-}" = "-x" ] ; then set -xv; shift; fi

# bin/$RCSfile$  $Revision$

ptime() {
python -c '
import time
print time.strftime("%c",time.localtime('$1'))
'
}

# write the output to a sub-directory in the inquisitor's web directory
output=`conf.sh -k inquisitor | awk '($1 ~ /html_file/) {print $2}' | sed -e "s/'//g" -e "s/,//g"`tape_inventory
if [ "$output" = "" ]; then exit 2; fi
if [ ! -d $output ] ; then mkdir -p $output || exit 3; fi
#echo $output

# get all the volumes that have been defined
vols=`ecmd vcc --vols | sed -e "s/'//g" -e "s/,/ /g"`
#echo $vols

# now loop over them and save the output
for vol in $vols; do
  #echo $vol
  finfo=`ecmd fcc --list=$vol`
  vinfo=`ecmd vcc --vol=$vol`
  la=`echo "$vinfo" | awk '($1 ~ /last_access/) {print $2}'`
  lat="`ptime $la`"
  b=`echo "$vinfo"  | awk '($1 ~ /remaining_bytes/ ) {print $2}' | sed -e 's/L,//g'`
  gb=`echo "$b / 1073741824" | bc`
  si=`echo "$vinfo"  | awk '($1 ~ /system_inhibit/ ) {print $2}' | sed -e "s/'//g" -e "s/,//g"`
  ui=`echo "$vinfo"  | awk '($1 ~ /user_inhibit/ )   {print $2}' | sed -e "s/'//g" -e "s/,//g"`
  out=$output/$vol
  if [ -e $out ]; then rm $out;fi
  echo "Volume:           $vol"    >>$out
  echo "Last accessed on: $lat"    >>$out
  echo "GBytes free:      $gb"     >>$out
  echo "Inhibits:         $si+$ui" >>$out
  echo                             >>$out
  echo "$finfo"                    >>$out
  echo                             >>$out
  echo "$vinfo"                    >>$out

done
