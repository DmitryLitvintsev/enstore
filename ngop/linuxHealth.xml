<MA-config Update="180" Name="LinuxHealthAgent">
   <NCS Heartbeat="300" Port="19997" Host="ngop"/>
      <DaemonList Name="SystemDaemon">
        <Daemon Name="syslogd"/>
        <Daemon Name="inetd"/>
        <Daemon Name="crond"/>
   </DaemonList>
      <System Name="OSHealth" Cluster="localhost">
          <MonitoredElement Name="cpuLoad" Host="localhost" Type="sysUsage">
          <ConditionSet>
        	<fn Name="plug_ins" Arg="uptime|/bin/sed s/.*load.*average://|awk -F',' '{print $3}'" RetVal="float:cpuLoad"/>
   	  <Condition State="1" SevLevel="6" Description="Average cpu load during last 15 min exceeds 4">
    		<apply>
       		<geq/>
         	<ci>cpuLoad</ci>
         	<cn>4.0</cn>
    		</apply>
       	  </Condition>
          <Condition State="1" SevLevel="5" Description="Average cpu load is between 3 and 4 during last 15 min">
                <apply>
		<and/>
		<apply>
                  <geq/>
                  <ci>cpuLoad</ci>
                  <cn>3.0</cn>
                </apply>
                <apply>
                  <lt/>
                  <ci>cpuLoad</ci>
                  <cn>4.0</cn>
                </apply>
		</apply>
          </Condition>
          <Condition State="1" SevLevel="4" Description="Average cpu load is between 2 and 3 during last 15 min">
                <apply>
		<and/>
		<apply>
                  <geq/>
                  <ci>cpuLoad</ci>
                  <cn>2.0</cn>
                </apply>
                <apply>
                  <lt/>
                  <ci>cpuLoad</ci>
                  <cn>3.0</cn>
                </apply>
		</apply>
          </Condition>
         </ConditionSet>
    </MonitoredElement>
    
        <MonitoredElement Name="Memory" Host="localhost" Type="sysUsage">
           <ConditionSet>
		<fn Name="plug_ins" Arg="free -o|grep Mem:|awk '{print $2} {print $3} {print $6} {print $7}' " RetVal="float:total,float:used,float:buffers,float:cached"/>
   		<Condition State="1" SevLevel="5" Description="Memory utilization exceeds 99%">
    		<apply>	
       		  <gt/>
		  <apply>
	  	   <divide/>
	  	   <apply>
	   		<minus/>
	   		<ci>used</ci>
	   		<ci>cached</ci>
           		<ci>buffers</ci>
	          </apply>
	          <ci>total</ci>
                 </apply>
         	 <cn>0.99</cn>
    		</apply>
    		</Condition>
	   </ConditionSet>
        </MonitoredElement>
  	<MonitoredElement Name="Swap" Host="localhost" Type="sysUsage">
            <ConditionSet>
        	<fn Name="plug_ins" Arg="free -o|grep Swap:|awk '{print $2} {print $3} '" RetVal="float:total,float:used"/>
   		<Condition State="0" SevLevel="6" Description="Swap utilization exceeds 30%">
    		<apply>
       		<gt/>
        	   <apply>
                  	<divide/>
           		<ci>used</ci>
           		<ci>total</ci>
        	   </apply>
         	   <cn>0.30</cn>
    		</apply>
    		</Condition>
   		<Condition State="1" SevLevel="5" Description="Swap utilization between 20 and 30%">
    		<apply>
		<and/>
		 <apply>
       		 <geq/>
        	   <apply>
                  	<divide/>
           		<ci>used</ci>
           		<ci>total</ci>
        	   </apply>
         	   <cn>0.20</cn>
    		 </apply>
		 <apply>
       		 <lt/>
        	   <apply>
                  	<divide/>
           		<ci>used</ci>
           		<ci>total</ci>
        	   </apply>
         	   <cn>0.30</cn>
    		 </apply>
		</apply>
    		</Condition>
   		<Condition State="1" SevLevel="4" Description="Swap utilization between 10 and 20%">
    		<apply>
		<and/>
		 <apply>
       		 <geq/>
        	   <apply>
                  	<divide/>
           		<ci>used</ci>
           		<ci>total</ci>
        	   </apply>
         	   <cn>0.10</cn>
    		 </apply>
		 <apply>
       		 <lt/>
        	   <apply>
                  	<divide/>
           		<ci>used</ci>
           		<ci>total</ci>
        	   </apply>
         	   <cn>0.20</cn>
    		 </apply>
		</apply>
    		</Condition>
         </ConditionSet>
    </MonitoredElement>
 	   <MonitoredElement Name="/home" Host="localhost" Type="FileSystem">
		<ConditionSet>
		   <fn Name="plug_ins" Arg="df /dev/hda | grep -v Filesystem|awk '{print $5}'|sed s/\\%//" RetVal="int:size"/>
		   <Condition State="1" SevLevel="5" Description="/home between 85 and 95%">	
    		    <apply>

		     <and/>
		     <apply>
                      <geq/>
                      <ci>size</ci>
                      <cn>85</cn>
                     </apply>
		     <apply>
                      <lt/>
                      <ci>size</ci>
                      <cn>95</cn>
                     </apply>
		    </apply>		
   		   </Condition>	
		   <Condition State="1" SevLevel="6" Description="/home size exceeds 95%">	
    		    <apply>
                      <geq/>
                      <ci>size</ci>
                      <cn>95</cn>
		    </apply>
   		   </Condition>
	 	</ConditionSet>
    	    </MonitoredElement>   
 	   <MonitoredElement Name="/diska" Host="localhost" Type="FileSystem">
		<ConditionSet>
		   <fn Name="plug_ins" Arg="df /diska 2> /dev/null| grep -v Filesystem|awk '{print $5}'|sed s/\\%//" RetVal="int:size"/>
		   <Condition State="1" SevLevel="5" Description="/diska between 85 and 95%">	
    		    <apply>

		     <and/>
		     <apply>
                      <geq/>
                      <ci>size</ci>
                      <cn>85</cn>
                     </apply>
		     <apply>
                      <lt/>
                      <ci>size</ci>
                      <cn>95</cn>
                     </apply>
		    </apply>		
   		   </Condition>	
		   <Condition State="1" SevLevel="6" Description="/diska size exceeds 95%">	
    		    <apply>
                      <geq/>
                      <ci>size</ci>
                      <cn>95</cn>
		    </apply>
   		   </Condition>
	 	</ConditionSet>
    	    </MonitoredElement>   
 	   <MonitoredElement Name="/diskb" Host="localhost" Type="FileSystem">
		<ConditionSet>
		   <fn Name="plug_ins" Arg="df /diskb 2> /dev/null| grep -v Filesystem|awk '{print $5}'|sed s/\\%//" RetVal="int:size"/>
		   <Condition State="1" SevLevel="5" Description="/diskb between 85 and 95%">	
    		    <apply>

		     <and/>
		     <apply>
                      <geq/>
                      <ci>size</ci>
                      <cn>85</cn>
                     </apply>
		     <apply>
                      <lt/>
                      <ci>size</ci>
                      <cn>95</cn>
                     </apply>
		    </apply>		
   		   </Condition>	
		   <Condition State="1" SevLevel="6" Description="/diskb size exceeds 95%">	
    		    <apply>
                      <geq/>
                      <ci>size</ci>
                      <cn>95</cn>
		    </apply>
   		   </Condition>
	 	</ConditionSet>
    	    </MonitoredElement>   
 	   <MonitoredElement Name="/diskc" Host="localhost" Type="FileSystem">
		<ConditionSet>
		   <fn Name="plug_ins" Arg="df /diskc 2> /dev/null| grep -v Filesystem|awk '{print $5}'|sed s/\\%//" RetVal="int:size"/>
		   <Condition State="1" SevLevel="5" Description="/diskc between 85 and 95%">	
    		    <apply>

		     <and/>
		     <apply>
                      <geq/>
                      <ci>size</ci>
                      <cn>85</cn>
                     </apply>
		     <apply>
                      <lt/>
                      <ci>size</ci>
                      <cn>95</cn>
                     </apply>
		    </apply>		
   		   </Condition>	
		   <Condition State="1" SevLevel="6" Description="/diskc size exceeds 95%">	
    		    <apply>
                      <geq/>
                      <ci>size</ci>
                      <cn>95</cn>
		    </apply>
   		   </Condition>
	 	</ConditionSet>
    	    </MonitoredElement>   
    <For Each="Daemon" In="DaemonList" Var="{%Var}" Name="SystemDaemon">
        <MonitoredElement Name="{%Var}" Host="localhost" Type="Daemon">
        <ConditionSet>
        <fn Name="plug_ins" Arg="cat /proc/[0-9]*/stat|grep \(*{%Var}\)|wc -l" RetVal="int:alive"/>
   	<Condition State="0" SevLevel="0" Description="{%Var} is dead">
    	<apply>
       	<eq/>
         <ci>alive</ci>
         <cn>0</cn>
    	</apply>
    	</Condition>
	</ConditionSet>
    	</MonitoredElement>
    </For>
    <MonitoredElement Name="timeSync" Host="localhost" Type="Daemon">
        <ConditionSet>
        <fn Name="plug_ins" Arg="cat /proc/[0-9]*/stat|grep \(*xntpd\)|wc -l;echo `/usr/sbin/xntpdc -p | grep '*'|awk '{print $8}'`" RetVal="int:alive,float:disp"/>
   	<Condition State="0" SevLevel="0" Description="xntpd is dead">
    	<apply>
       	<eq/>
         <ci>alive</ci>
         <cn>0</cn>
    	</apply>
    	</Condition>
    	<Condition State="1" SevLevel="6" Description="Time is not syncronized (> 3 seconds off)">
    	<apply>
        <and/>
        <apply>
       	<eq/>
         <ci>alive</ci>
         <cn>1</cn>
    	</apply>
        <apply>
       	<geq/>
         <ci>disp</ci>
         <cn>3.0</cn>
    	</apply>
        </apply>
    	</Condition>       
    	<Condition State="1" SevLevel="5" Description="Time is not syncronized (inbetween 1 and 3 seconds off)">
    	<apply>
        <and/>
        <apply>
       	<eq/>
         <ci>alive</ci>
         <cn>1</cn>
    	</apply>
        <apply>
       	<geq/>
         <ci>disp</ci>
         <cn>1.0</cn>
    	</apply>
	<apply>
	<lt/>
	  <ci>disp</ci>
	  <cn>3.0</cn>
	</apply>
        </apply>
    	</Condition>       
	</ConditionSet>
        
    	</MonitoredElement>
</System>

       <System Name="Hardware" Cluster="localhost">
      <MonitoredElement Name="numProcessors" Host="localhost" Type="Hardware">
         <ConditionSet>
         <fn Name="plug_ins" Arg="cat /proc/cpuinfo|grep processor|wc -l" RetVal="int:numPr"/>
         <Condition State="1" SevLevel="6" Description="Missing one processor">
            <apply>
	          <eq/>
                  <ci>numPr</ci>
                  <cn>1</cn>
            </apply>
	</Condition>
        <Condition State="0" SevLevel="0" Description="No processor info found in cpuinfo">
            <apply>
                  <eq/>
                  <ci>numPr</ci>
                  <cn>0</cn>
            </apply>
         </Condition>
        </ConditionSet>
       </MonitoredElement>
       <MonitoredElement Name="baseTemp" Host="localhost" Type="Hardware">
         <ConditionSet>
         <fn Name="plug_ins" Arg="/usr/local/bin/sdrread|grep 'Processor.*Temp:'|awk -F':' '{print $3}'|awk '{print $2}'|awk -F'C' '{print $2}'" RetVal="int:mask1,int:mask2"/>
         <Condition State="0" SevLevel="0" Description="Temperature is too high">
            <apply>
            <or/>
            <apply>
            <gt/>
             <ci>mask1</ci>
             <cn>4</cn>
            </apply>
            <apply>
            <gt/>
            <ci>mask2</ci>
            <cn>4</cn>
            </apply>
            </apply>
	</Condition>
          <Condition State="1" SevLevel="6" Description="Temperature is nearing warning level">
            <apply>
             <or/>
             <apply>
               <and/>
               <apply>
                 <gt/>
                 <ci>mask1</ci>
                 <cn>0</cn>
               </apply>
               <apply>
                <leq/>
                 <ci>mask1</ci>
                 <cn>4</cn>
                </apply>
              </apply>
            <apply>
            <and/>
             <apply>
              <gt/>
               <ci>mask2</ci>
               <cn>0</cn>
              </apply>
              <apply>
               <leq/>
               <ci>mask2</ci>
               <cn>4</cn>
              </apply>
             </apply>
            </apply>
	</Condition>       
        
        </ConditionSet>
       </MonitoredElement>
              <MonitoredElement Name="fanSpeed" Host="localhost" Type="Hardware">
         <ConditionSet>
         <fn Name="plug_ins" Arg="/usr/local/bin/sdrread|grep 'Processor.*Fan:'|awk -F':' '{print $3}'|awk '{print $1}'" RetVal="float:speed1,float:speed2"/>
         <Condition State="0" SevLevel="0" Description="Fan Speed is below 3000">
            <apply>
            <or/>
            <apply>
            <lt/>
            <ci>speed1</ci>
            <cn>3000</cn>
            </apply>
            <apply>
            <lt/>
            <ci>speed2</ci>
            <cn>3000</cn>
            </apply>
           </apply> 
	</Condition>
        </ConditionSet>
       </MonitoredElement>
	</System>
</MA-config>
