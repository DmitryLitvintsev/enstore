#!/bin/sh
set -u  # force better programming and ability to use check for not set
if [ "${1:-}" = "-x" ] ; then set -xv; shift; fi

# test/$RCSfile$  $Revision$

aits="DM05-CA2901-8MM DM06-CA2902-8MM DM07-CA2903-8MM DM08-CA2904-8MM"
mammoths="DC12-CA2251-8MM"
dlts="DE13-CA2501-DECDLT DE14-CA2502-DECDLT DE15-CA2503-DECDLT DE16-CA2504-DECDLT"

if [ -n "${1-}" ] ; then
  sets="$1";
  shift
else
  sets="$aits $mammoths $dlts"
fi

edismount() { if [ $1 -lt 0 ] ; then
                echo -1
              else
                wait $1 2>/dev/null
                drv=`echo $2 | tr '[a-z]' '[A-Z]'`
                rip-drive $drv offline 1>/dev/null 2>&1
                dasadmin dismount -d $drv </dev/null >/dev/null 2>&1 &
                echo $!
              fi
            }

emount()    { if [ $1 -lt 0 ] ; then
                echo -1
              else
                wait $1 2>/dev/null
                typ=`echo $2 | tr '[a-z]' '[A-Z]'`
                tap=`echo $3 | tr '[a-z]' '[A-Z]'`
                drv=`echo $4 | tr '[a-z]' '[A-Z]'`
                if [ `rip-drive $drv status | grep -c "DR_OPEN"` -eq 1 ] ; then
                  dasadmin mount -t $typ $tap $drv </dev/null >/dev/null 2>&1 &
                  echo $!
                else
                  echo -1
                fi
              fi
            }

eonline()   { if [ $1 -lt 0 ] ; then
                echo -1
              else
                wait $1 2>/dev/null
                drv=`echo $2 | tr '[a-z]' '[A-Z]'`
                tries=$3
                status=-1
                count=0
                while [ $count -le $tries -a $status -eq -1 ]; do
                  if [ `rip-drive $drv status | grep -c "ONLINE"` -eq 1 ] ; then
                    status=0
                  fi
                  sleep 1
                  count=`expr $count + 1`
                done
                echo $status
              fi
            }

while true; do

  for aset in $sets; do
    drive=`echo $aset | cut -f1 -d-`
    eval waitfor=\${I$drive:-0}
    /bin/echo -n dismount $waitfor $drive
    lastpid=`edismount $waitfor $drive`
    eval I$drive=\$lastpid
    echo " " $lastpid
  done

  for aset in $sets; do
    drive=`echo $aset | cut -f1 -d-`
    tape=`echo  $aset | cut -f2 -d-`
    mtype=`echo $aset | cut -f3 -d-`
    eval waitfor=\${I$drive:-0}
    /bin/echo -n mount $waitfor $mtype $tape $drive
    lastpid=`emount $waitfor $mtype $tape $drive`
    eval I$drive=\$lastpid
    echo " " $lastpid
  done

  for aset in $sets; do
    drive=`echo $aset | cut -f1 -d-`
    eval waitfor=\${I$drive:-0}
    tries=300
    /bin/echo -n online $waitfor $drive $tries
    lastpid=`eonline $waitfor $drive $tries`
    eval I$drive=\$lastpid
    echo " " $lastpid
  done

done
